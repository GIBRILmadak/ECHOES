<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHOES - Forums</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Feather Icons (single include) -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }
        .glass-card-light {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .gradient-text-dark {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .gradient-text-light {
            background: linear-gradient(90deg, #ec4899, #f97316);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* --- Ajout: règles de thème pour inverser la couleur du texte --- */
        /* variables par défaut (thème clair) */
        :root {
            --theme-text: #000000;
            --theme-muted: rgba(0,0,0,0.75);
        }
        /* thème sombre active (quand <html> a la classe 'dark') */
        html.dark {
            --theme-text: #ffffff;
            --theme-muted: rgba(255,255,255,0.85);
        }

        /* Appliquer couleur principale héritée au body */
        body {
            color: var(--theme-text);
        }

        /* Règles pour s'assurer que les utilitaires de couleur (text-white / text-black) suivent le thème */
        html.dark .text-white,
        html.dark .text-black {
            color: var(--theme-text) !important;
        }
        html:not(.dark) .text-white,
        html:not(.dark) .text-black {
            color: var(--theme-text) !important;
        }

        /* Rendre les textes avec opacity-75 lisibles selon le thème */
        .opacity-75 {
            color: var(--theme-muted) !important;
        }
        /* --- fin des ajouts --- */

        /* Cover image styles pour les cartes de discussion */
        /* Par défaut (petits écrans) : hauteur compacte pour mobile */
        .discussion-cover {
            position: relative;
            width: 100%;
            height: 140px; /* mobile / petits écrans */
            border-radius: 0.75rem 0.75rem 0 0;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-color: rgba(0, 0, 0, 0.1); /* Fond par défaut */
        }

		/* --- Ajouts : versions "compactes" pour bureau --- */
		@media (min-width: 1024px) {
			/* limiter la largeur des cartes pour les rendre plus aérées */
			.discussion-card {
				max-width: 520px;     /* taille compacte désirée */
				margin-left: auto;
				margin-right: auto;
				width: 100%;
			}
			/* réduire la hauteur de la couverture pour compacter l'apparence */
			.discussion-cover {
				aspect-ratio: 16 / 9; /* ratio plus horizontal */
				max-height: 260px;    /* hauteur réduite sur bureau */
                height: auto;
			}
			/* ajustements mineurs d'espacement si besoin */
			.discussion-card .discussion-card-body {
				padding: 1rem; /* légèrement plus compact */
			}
		}
		/* --- fin des ajouts --- */

        /* Fallback pour navigateurs sans support aspect-ratio */
        @supports not (aspect-ratio: 4/3) {
            @media (min-width: 1024px) {
                .discussion-cover {
                    height: calc(100% * 3 / 4); /* tentative, mais on conserve un max raisonnable */
                    max-height: 360px;
                }
            }
        }
        .discussion-cover img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .discussion-card-body {
            padding-top: 0.75rem; /* pour espacer contenu sous la couverture */
        }
        .cover-overlay {
            position: absolute;
            right: 8px;
            top: 8px;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .discussion-cover:hover .cover-overlay {
            opacity: 1;
        }
        .cover-overlay button {
            background: rgba(0,0,0,0.65);
            color: #fff;
            padding: 6px 8px;
            border-radius: 999px;
            border: none;
            font-size: 12px;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .cover-overlay button:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.05);
        }
        .cover-reset {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        /* Ensure the navigation floats above all content */
        .floating-nav {
            z-index: 99999; /* très au-dessus des autres éléments */
            pointer-events: auto; /* s'assurer que les boutons restent cliquables */
        }

        /* Style amélioré pour le bouton d'ajout de couverture */
        .cover-add-btn {
            background: rgba(59, 130, 246, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .cover-add-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 to-black text-white dark:text-dark-text dark:bg-gradient-to-br dark:from-blue-900 dark:to-black">
    <!-- Navigation -->
    <nav class="glass-card fixed bottom-4 left-1/2 transform -translate-x-1/2 rounded-full px-3 sm:px-6 py-2 sm:py-3 flex items-center justify-center space-x-3 sm:space-x-8 floating-nav">
        <a href="index.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="home" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="videos.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="video" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="music.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="mic" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="forum.html" class="p-1 sm:p-2 rounded-full bg-dark-secondary bg-opacity-30">
            <i data-feather="message-square" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="messages.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="mail" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="calm.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="book" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 pt-8 pb-24">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold gradient-text-dark dark:gradient-text-dark">ECHOES Forum</h1>
                <p class="text-sm opacity-75">Discutez, échangez, partagez</p>
            </div>
            <a href="profile.html" class="flex items-center space-x-2 glass-card rounded-full px-4 py-2">
                <img src="http://static.photos/people/200x200/42" alt="Profile" class="w-8 h-8 rounded-full">
                <span>Mon Profil</span>
            </a>
        </header>

        <!-- Search and Create -->
        <div class="glass-card rounded-2xl p-4 mb-6">
            <div class="flex items-center space-x-3">
                <div class="flex-1 relative">
                    <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 opacity-50"></i>
                    <input type="text" placeholder="Rechercher dans le forum..." class="w-full pl-10 pr-4 py-2 bg-transparent border border-dark-secondary rounded-full focus:outline-none focus:border-dark-accent">
                </div>
                <!-- bouton 'Créer' activé -->
                <button id="create-btn" type="button" aria-haspopup="dialog" aria-controls="create-modal" class="bg-dark-accent text-white px-4 py-2 rounded-full flex items-center space-x-1">
                    <i data-feather="plus" class="w-4 h-4"></i>
                    <span>Créer</span>
                </button>
            </div>
        </div>

        <!-- Categories -->
        <div class="glass-card rounded-2xl p-4 mb-6 overflow-x-auto">
            <div class="flex space-x-4">
                <button class="category-filter whitespace-nowrap px-4 py-1 rounded-full bg-dark-accent text-white">Tous</button>
                <button class="category-filter whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">technologie</button>
                <button class="category-filter whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">divertissement</button>
                <button class="category-filter whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">santé</button>
                <button class="category-filter whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">éducation</button>
                <button class="category-filter whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">voyage</button>
            </div>
        </div>

        <!-- Modale création de discussion (hidden par défaut) -->
        <div id="create-modal" class="fixed inset-0 z-50 hidden items-center justify-center px-4" role="dialog" aria-modal="true" aria-labelledby="create-modal-title">
            <div class="fixed inset-0 bg-black/60"></div>
            <div class="glass-card relative rounded-2xl max-w-2xl w-full mx-auto p-4 z-10">
                <h3 id="create-modal-title" class="text-lg font-semibold mb-2">Créer une discussion</h3>
                <form id="create-form" class="space-y-3">
                    <input id="new-title" required class="w-full p-2 bg-transparent border rounded" placeholder="Titre">
                    <textarea id="new-content" required class="w-full p-2 bg-transparent border rounded" rows="4" placeholder="Contenu..."></textarea>
                    <input id="new-tags" class="w-full p-2 bg-transparent border rounded" placeholder="#tags séparés par des espaces">
                    <div class="flex items-center space-x-3">
                        <input type="file" id="new-cover" accept="image/*" class="hidden">
                        <button type="button" id="new-cover-btn" class="cover-add-btn">
                            <i data-feather="image" class="w-4 h-4"></i>
                            <span>Ajouter une couverture</span>
                        </button>
                        <img id="new-cover-preview" class="w-24 h-16 object-cover rounded hidden" alt="Preview">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="create-cancel" class="px-3 py-2 rounded bg-gray-200 text-black">Annuler</button>
                        <button type="submit" id="create-submit" class="px-4 py-2 rounded bg-dark-accent text-white">Publier</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Popular Discussions -->
        <h2 class="text-xl font-bold mb-4">Discussions populaires</h2>
        <div id="popular-discussions" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8 items-stretch">
            <!-- Discussions chargées dynamiquement -->
        </div>

        <!-- Recent Discussions -->
        <h2 class="text-xl font-bold mb-4">Discussions récentes</h2>
        <div id="recent-discussions" class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
            <!-- Discussions chargées dynamiquement -->
        </div>
    </div>

    <script>
        // Improved initialization: run after DOM is ready, initialize AOS and Feather,
        // then manage theme toggle and icon updates via feather.icons API to avoid
        // referencing elements replaced by feather.replace().
        document.addEventListener('DOMContentLoaded', () => {
            const html = document.documentElement;
            const body = document.body;

            // Init AOS
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true
            });

            // Init feather icons
            feather.replace();

            // Theme handled globally by global-theme.js
            try {
                if (window.setTheme) {
                    const saved = localStorage.getItem('theme');
                    if (saved) window.setTheme(saved);
                }
            } catch (e) {}

            // --- Cover image management ---
            const COVER_KEY_PREFIX = 'forum_cover_';

            // Apply saved cover images from localStorage
            function loadSavedCovers() {
                document.querySelectorAll('[data-discussion-id]').forEach(card => {
                    const id = card.getAttribute('data-discussion-id');
                    const coverEl = document.getElementById(`cover-${id}`);
                    if (!coverEl) return;
                    const saved = localStorage.getItem(COVER_KEY_PREFIX + id);
                    if (saved) {
                        coverEl.style.backgroundImage = `url('${saved}')`;
                    }
                });
            }

            // Handle file input change: read image and save
            function handleFileInput(file, id) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    const coverEl = document.getElementById(`cover-${id}`);
                    if (coverEl) {
                        coverEl.style.backgroundImage = `url('${dataUrl}')`;
                        localStorage.setItem(COVER_KEY_PREFIX + id, dataUrl);
                    }
                };
                reader.readAsDataURL(file);
            }

            // Wire up buttons and inputs
            function initCoverControls() {
                // open file picker when clicking change button
                document.querySelectorAll('.change-cover-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-target');
                        const input = document.querySelector(`.file-input[data-target="${id}"]`);
                        if (input) input.click();
                    });
                });

                // reset button
                document.querySelectorAll('.change-reset-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-target');
                        localStorage.removeItem(COVER_KEY_PREFIX + id);
                        const coverEl = document.getElementById(`cover-${id}`);
                        if (coverEl) {
                            // fallback image (you can replace with any default)
                            coverEl.style.backgroundImage = '';
                        }
                    });
                });

                // file input change
                document.querySelectorAll('.file-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        const id = input.getAttribute('data-target');
                        if (file && id) handleFileInput(file, id);
                        // reset input value to allow same file re-upload
                        input.value = '';
                    });
                });
            }

            // Run cover init after feather icons have been replaced
            // (feather.replace() above already ran; re-run to render new inline svgs inside buttons)
            feather.replace();
            loadSavedCovers();
            initCoverControls();

            // Initialize forum dynamic content
            if (window.echoesForum) {
                window.echoesForum.initForumUI();
            }
        });
    </script>

    <!-- Script pour la modale 'Créer' et insertion dynamique d'une carte -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const createBtn = document.getElementById('create-btn');
            const modal = document.getElementById('create-modal');
            const cancelBtn = document.getElementById('create-cancel');
            const form = document.getElementById('create-form');
            const fileInput = document.getElementById('new-cover');
            const fileBtn = document.getElementById('new-cover-btn');
            const preview = document.getElementById('new-cover-preview');
            const recentGrid = document.getElementById('recent-grid');
            const COVER_KEY_PREFIX = 'forum_cover_';

            function openModal() {
                modal.classList.remove('hidden');
                const first = modal.querySelector('input, textarea');
                if (first) first.focus();
            }
            function closeModal() {
                modal.classList.add('hidden');
                form.reset();
                preview.src = '';
                preview.classList.add('hidden');
                delete preview.dataset.url;
            }

            createBtn?.addEventListener('click', openModal);
            cancelBtn?.addEventListener('click', closeModal);
            fileBtn?.addEventListener('click', () => fileInput.click());

            fileInput?.addEventListener('change', (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    preview.src = ev.target.result;
                    preview.dataset.url = ev.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(f);
            });

            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('new-title').value.trim();
                const content = document.getElementById('new-content').value.trim();
                const tagsInput = document.getElementById('new-tags').value.trim();
                const coverData = preview.dataset.url || '';

                try {
                    // Créer le post dans la base de données
                    const tags = tagsInput ? tagsInput.split(/\s+/).filter(t => t.trim()) : null;
                    const createdPost = await window.echoesPosts.createPost(content, null, null, null, tags);

                    // Fermer le modal et nettoyer
                    closeModal();

                    // Rafraîchir le forum pour afficher le nouveau post
                    if (window.echoesForum && window.echoesForum.initForumUI) {
                        await window.echoesForum.initForumUI();
                    }

                } catch (error) {
                    console.error('Erreur création discussion:', error);
                    alert('Erreur lors de la création de la discussion: ' + (error?.message || error));
                }
            });

            function escapeHtml(str) {
                return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
            }
        });
    </script>
<script src="supabase-config.js"></script>
<script src="supabase-client.js"></script>
<script src="global-theme.js"></script>
<script src="user-badge-display.js"></script>
<script src="dynamic-interactions.js"></script>
<script src="badge-system.js"></script>
<script src="background-init.js"></script>
<script src="posts.js"></script>
<script src="forum.js"></script>
</body>
</html>
