<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHOES - Podcasts</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }
        .glass-card-light {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .gradient-text-dark {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .gradient-text-light {
            background: linear-gradient(90deg, #ec4899, #f97316);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal-overlay.open { display: flex; }
        .modal-panel {
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: auto;
            border-radius: 12px;
            padding: 18px;
        }
        .modal-close {
            position: absolute;
            right: 12px;
            top: 12px;
        }

        /* Ajout : navigation "survolante" (lift + transition) */
        .floating-nav {
            z-index: 55; /* au-dessus du contenu mais sous le modal (modal z-index:60) */
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }
        /* On ajoute translateX(-50%) ici pour conserver le centrage Tailwind + ajouter un lÃ©ger lift */
        .floating-nav:hover {
            transform: translateX(-50%) translateY(-6px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.45);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 to-black text-white dark:text-dark-text dark:bg-gradient-to-br dark:from-blue-900 dark:to-black">
    <!-- Navigation -->
    <nav class="glass-card floating-nav fixed bottom-4 left-1/2 transform -translate-x-1/2 rounded-full px-3 sm:px-6 py-2 sm:py-3 flex items-center justify-center space-x-3 sm:space-x-8">
        <a href="index.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="home" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="videos.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="video" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="music.html" class="p-1 sm:p-2 rounded-full bg-dark-secondary bg-opacity-30">
            <i data-feather="mic" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="forum.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="message-square" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="messages.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="mail" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <a href="calm.html" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="book" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </a>
        <button id="theme-toggle" class="p-1 sm:p-2 rounded-full hover:bg-dark-secondary dark:hover:bg-opacity-30">
            <i data-feather="moon" id="theme-icon" class="w-4 h-4 sm:w-5 sm:h-5"></i>
        </button>
    </nav>

    <!-- Boutons fixes en haut -->
    <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 flex space-x-2">
        <button id="open-publish-btn" class="glass-card rounded-full px-4 py-2 flex items-center space-x-2">
            <i data-feather="upload" class="w-4 h-4"></i>
            <span class="hidden sm:inline">Publier / Playlists</span>
        </button>
        <button id="search-toggle-btn" class="glass-card rounded-full px-4 py-2 flex items-center space-x-2">
            <i data-feather="search" class="w-4 h-4"></i>
            <span class="hidden sm:inline">Rechercher</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 pt-8 pb-32">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold gradient-text-dark dark:gradient-text-dark">ECHOES Music</h1>
                <p class="text-sm opacity-75">DÃ©couvrez, partagez et promouvez votre musique</p>
            </div>
            <a href="profile.html" class="flex items-center space-x-2 glass-card rounded-full px-4 py-2">
                <img src="http://static.photos/people/200x200/42" alt="Profile" class="w-8 h-8 rounded-full">
                <span>Mon Profil</span>
            </a>
        </header>

        <!-- Featured Track -->
        <div id="featured-track" class="glass-card rounded-2xl p-6 mb-8" data-aos="fade-up" style="display: none;">
            <div class="flex items-center space-x-4 mb-4">
                <img id="featured-cover" src="" alt="Featured Track" class="w-16 h-16 rounded-xl">
                <div>
                    <h2 class="font-bold text-lg">ðŸŽµ Titre Ã  la une</h2>
                    <p id="featured-description" class="text-sm opacity-75"></p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="featured-play-btn" class="w-12 h-12 rounded-full bg-dark-accent flex items-center justify-center">
                        <i data-feather="play" class="w-5 h-5 text-white"></i>
                    </button>
                    <div>
                        <h3 id="featured-title"></h3>
                        <p id="featured-info" class="text-xs opacity-75"></p>
                    </div>
                </div>
                <!-- like button with count and data-id -->
                <button id="featured-like-btn" class="like-btn flex items-center text-dark-accent" data-id="" title="J'aime">
                    <i data-feather="heart" class="w-4 h-4"></i>
                    <span class="ml-2 text-xs like-count">0</span>
                </button>
            </div>
        </div>

        <!-- Barre de recherche (cachÃ©e par dÃ©faut) -->
        <div id="search-container" class="glass-card rounded-2xl p-4 mb-6 hidden">
            <div class="flex items-center space-x-3">
                <div class="flex-1 relative">
                    <input id="search-input" type="text" placeholder="Rechercher des titres, artistes ou podcasts..." 
                           class="w-full px-4 py-2 pl-10 rounded-lg bg-transparent border border-white/20 focus:border-white/40 focus:outline-none">
                    <i data-feather="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
                </div>
                <button id="search-clear-btn" class="px-3 py-2 rounded-lg bg-dark-secondary bg-opacity-30 hover:bg-opacity-50">
                    <i data-feather="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="search-results" class="mt-4 space-y-2 hidden">
                <!-- Les rÃ©sultats de recherche apparaÃ®tront ici -->
            </div>
        </div>

        <!-- Genres Musicaux -->
        <div class="glass-card rounded-2xl p-4 mb-6 overflow-x-auto">
            <div class="flex space-x-4">
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-accent text-white">Tendances</button>
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">Pop</button>
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">Rock</button>
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">Hip-Hop</button>
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">Ã‰lectronique</button>
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">R&B</button>
                <button class="whitespace-nowrap px-4 py-1 rounded-full bg-dark-secondary bg-opacity-30">Jazz</button>
            </div>
        </div>

        <!-- Artistes Populaires -->
        <h2 class="text-xl font-bold mb-4">ðŸŽ¶ Artistes Ã  dÃ©couvrir</h2>
        <div id="popular-artists" class="grid grid-cols-2 gap-4 mb-8">
            <!-- Les artistes populaires seront chargÃ©s dynamiquement -->
        </div>

        <!-- Nouveaux Titres -->
        <h2 class="text-xl font-bold mb-4">ðŸŽµ NouveautÃ©s musicales</h2>
        <div id="latest-tracks" class="space-y-4">
            <!-- Les nouveaux titres seront chargÃ©s dynamiquement -->
        </div>

        <!-- Modal: Publier + Playlists (hidden by default) -->
        <div id="publish-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
            <div class="modal-panel glass-card rounded-2xl p-6 relative" role="document">
                <button id="close-publish-btn" class="modal-close p-2 rounded-full hover:bg-dark-secondary" title="Fermer">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>

                <h2 class="text-lg font-bold mb-3">ðŸŽµ Promouvoir votre musique</h2>
                <p class="text-sm opacity-75 mb-4">Partagez vos crÃ©ations musicales avec la communautÃ© ECHOES et gagnez en visibilitÃ© !</p>

                <!-- Formulaire de publication (mÃªmes id que prÃ©cÃ©demment pour compatibilitÃ© JS) -->
                <form id="publish-music-form" class="space-y-3">
                    <div class="flex space-x-3">
                        <input id="music-title" type="text" placeholder="Titre du morceau" required
                               class="flex-1 px-3 py-2 rounded-lg bg-transparent border border-white/10">
                        <input id="music-artist" type="text" placeholder="Nom de l'artiste" required
                               class="w-48 px-3 py-2 rounded-lg bg-transparent border border-white/10">
                    </div>
                    <div class="flex space-x-3">
                        <input id="music-cover" type="url" placeholder="URL de la pochette (optionnel)"
                               class="flex-1 px-3 py-2 rounded-lg bg-transparent border border-white/10">
                        <input id="music-duration" type="text" placeholder="DurÃ©e (ex: 03:45)"
                               class="w-36 px-3 py-2 rounded-lg bg-transparent border border-white/10">
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="music-genre" class="px-3 py-2 rounded-lg bg-transparent border border-white/10">
                            <option value="">Genre</option>
                            <option>Pop</option>
                            <option>Rock</option>
                            <option>Ã‰lectronique</option>
                            <option>Hip-hop</option>
                            <option>Classique</option>
                            <option>Autre</option>
                        </select>
                        <!-- File input kept for UX but not uploaded in this demo -->
                        <input id="music-file" type="file" accept="audio/*" class="text-sm">
                        <button type="submit" class="ml-auto px-4 py-2 rounded-full bg-dark-accent">Publier</button>
                    </div>
                </form>
                <p id="publish-feedback" class="text-sm mt-2 opacity-75"></p>

                <hr class="my-4 border-white/10">

                <h2 class="text-lg font-bold mb-3">ðŸŽ§ Vos Albums & Playlists</h2>
                <p class="text-sm opacity-75 mb-4">Organisez votre musique en albums et crÃ©ez des playlists thÃ©matiques pour vos fans.</p>

                <form id="create-playlist-form" class="flex items-center space-x-3 mb-4">
                    <input id="playlist-name" type="text" placeholder="Nom de la playlist" required
                           class="flex-1 px-3 py-2 rounded-lg bg-transparent border border-white/10">
                    <button type="submit" class="px-4 py-2 rounded-full bg-dark-accent">CrÃ©er</button>
                </form>

                <div id="playlists-container" class="space-y-3">
                    <!-- playlists render here -->
                </div>

                <hr class="my-4 border-white/10">

                <h2 class="text-xl font-bold mt-4 mb-2">ðŸŽ¤ Votre catalogue musical</h2>
                <div id="published-music" class="grid grid-cols-2 gap-4 mb-2">
                    <!-- Les morceaux publiÃ©s par le formulaire apparaitront ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Removed the fixed Podcast Player HTML block so nothing overlays the page. -->

    <script>
        // filepath: c:\Users\DELL\Desktop\ECHOES\podcast.html
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize AOS if available
            if (window.AOS && typeof AOS.init === 'function') {
                AOS.init({
                    duration: 800,
                    easing: 'ease-in-out',
                    once: true
                });
            }

            // Initialize feather icons if available
            if (window.feather && typeof feather.replace === 'function') {
                feather.replace();
            }

            // Theme toggle - get elements after DOM ready and guard existence
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const html = document.documentElement;

            if (themeToggle && themeIcon && html) {
                themeToggle.addEventListener('click', () => {
                    html.classList.toggle('dark');

                    if (html.classList.contains('dark')) {
                        // Dark mode
                        document.body.className = 'min-h-screen bg-gradient-to-br from-blue-900 to-black dark:text-dark-text dark:bg-gradient-to-br dark:from-blue-900 dark:to-black';
                        themeIcon.setAttribute('data-feather', 'moon');
                    } else {
                        // Light mode
                        document.body.className = 'min-h-screen bg-gradient-to-br from-pink-50 to-rose-100 text-black';
                        themeIcon.setAttribute('data-feather', 'sun');
                    }

                    if (window.feather && typeof feather.replace === 'function') {
                        feather.replace();
                    }
                });
            }

            // --- Nouvelle logique: gestion du formulaire de publication musique, likes, playlists ---
            const form = document.getElementById('publish-music-form');
            const feedback = document.getElementById('publish-feedback');
            const publishedContainer = document.getElementById('published-music');
            const playlistsContainer = document.getElementById('playlists-container');
            const createPlaylistForm = document.getElementById('create-playlist-form');

            // Variables globales pour les donnÃ©es dynamiques
            let supabaseClient = null;
            let currentUser = null;
            let featuredTrack = null;
            let popularArtists = [];
            let latestTracks = [];
            let userTracks = [];
            let userPlaylists = [];
            let musicLikes = {}; // { musicId: { liked: bool, count: number } }

            // Local storage keys pour la compatibilitÃ©
            const KEY_LIKES = 'echoes_likes';
            const KEY_TRACKS = 'echoes_tracks';
            const KEY_PLAYLISTS = 'echoes_playlists';

            // load/save helpers pour la compatibilitÃ© locale
            function loadJson(key, fallback) {
                try {
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : fallback;
                } catch (e) {
                    return fallback;
                }
            }
            function saveJson(key, obj) { localStorage.setItem(key, JSON.stringify(obj)); }

            // Charger les donnÃ©es depuis Supabase
            async function loadMusicData() {
                try {
                    if (!supabaseClient) {
                        supabaseClient = await window.getSupabase();
                        const { data: { user } } = await supabaseClient.auth.getUser();
                        currentUser = user;
                    }

                    // Charger les tracks publiÃ©s par l'utilisateur actuel
                    const { data: tracks, error: tracksError } = await supabaseClient
                        .from('music')
                        .select(`
                            *,
                            profiles:author_id (
                                username,
                                full_name,
                                avatar_url
                            )
                        `)
                        .eq('author_id', currentUser?.id)
                        .order('created_at', { ascending: false });

                    if (tracksError) throw tracksError;
                    userTracks = tracks || [];

                    // Charger les likes de l'utilisateur
                    if (currentUser) {
                        const { data: likes, error: likesError } = await supabaseClient
                            .from('music_likes')
                            .select('music_id')
                            .eq('user_id', currentUser.id);

                        if (!likesError) {
                            likes.forEach(like => {
                                musicLikes[like.music_id] = { liked: true };
                            });
                        }
                    }

                    // Charger les tracks populaires (par nombre de likes)
                    const { data: popular, error: popularError } = await supabaseClient
                        .from('music')
                        .select(`
                            *,
                            profiles:author_id (
                                username,
                                full_name,
                                avatar_url
                            )
                        `)
                        .order('likes_count', { ascending: false })
                        .limit(4);

                    if (!popularError) {
                        popularArtists = popular.map(track => ({
                            id: track.id,
                            name: track.artist,
                            genre: track.genre,
                            avatar: track.cover_url || track.profiles?.avatar_url || 'images/default-profil.jpg',
                            trackCount: 1 // SimplifiÃ© pour l'instant
                        }));
                    }

                    // Charger les nouveaux tracks
                    const { data: latest, error: latestError } = await supabaseClient
                        .from('music')
                        .select(`
                            *,
                            profiles:author_id (
                                username,
                                full_name,
                                avatar_url
                            )
                        `)
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (!latestError) {
                        latestTracks = latest;
                    }

                    // Charger le track Ã  la une (le plus populaire)
                    const { data: featured, error: featuredError } = await supabaseClient
                        .from('music')
                        .select(`
                            *,
                            profiles:author_id (
                                username,
                                full_name,
                                avatar_url
                            )
                        `)
                        .order('likes_count', { ascending: false })
                        .limit(1);

                    if (!featuredError && featured.length > 0) {
                        featuredTrack = featured[0];
                    }

                    // Charger les playlists de l'utilisateur
                    if (currentUser) {
                        const { data: playlists, error: playlistsError } = await supabaseClient
                            .from('playlists')
                            .select('*')
                            .eq('author_id', currentUser.id)
                            .order('created_at', { ascending: false });

                        if (!playlistsError) {
                            userPlaylists = playlists || [];
                        }
                    }

                } catch (error) {
                    console.error('Erreur lors du chargement des donnÃ©es musique:', error);
                    // Fallback vers localStorage
                    userTracks = loadJson(KEY_TRACKS, []);
                    musicLikes = loadJson(KEY_LIKES, {});
                    userPlaylists = loadJson(KEY_PLAYLISTS, []);
                }
            }

            // Fonctions d'affichage
            function renderFeaturedTrack() {
                const container = document.getElementById('featured-track');
                if (!featuredTrack) {
                    container.style.display = 'none';
                    return;
                }

                document.getElementById('featured-cover').src = featuredTrack.cover_url || 'images/default-profil.jpg';
                document.getElementById('featured-description').textContent = `Nouveau single de ${featuredTrack.artist}`;
                document.getElementById('featured-title').textContent = featuredTrack.title;
                document.getElementById('featured-info').textContent = `${featuredTrack.artist} â€¢ ${featuredTrack.genre || 'Musique'} â€¢ ${featuredTrack.duration || ''} â€¢ ${featuredTrack.plays_count || 0} Ã©coutes`;
                document.getElementById('featured-like-btn').setAttribute('data-id', featuredTrack.id);
                document.getElementById('featured-like-btn').querySelector('.like-count').textContent = featuredTrack.likes_count || 0;

                container.style.display = 'block';
            }

            function renderPopularArtists() {
                const container = document.getElementById('popular-artists');
                container.innerHTML = '';

                if (popularArtists.length === 0) {
                    container.innerHTML = '<div class="col-span-2 text-center text-sm opacity-75 py-8">Aucun artiste trouvÃ©</div>';
                    return;
                }

                popularArtists.forEach(artist => {
                    const div = document.createElement('div');
                    div.className = 'glass-card rounded-xl p-3';
                    div.setAttribute('data-aos', 'fade-up');
                    div.innerHTML = `
                        <img src="${escapeHtml(artist.avatar)}" alt="Artiste" class="w-full rounded-lg mb-2">
                        <h3 class="font-medium text-sm">${escapeHtml(artist.name)}</h3>
                        <p class="text-xs opacity-75">${escapeHtml(artist.genre || 'Musique')} â€¢ ${artist.trackCount} titre(s)</p>
                        <div class="mt-2 flex justify-end">
                            <button class="like-btn flex items-center text-dark-accent" data-id="artist-${artist.id}" title="J'aime">
                                <i data-feather="heart" class="w-4 h-4"></i><span class="ml-1 text-xs like-count">0</span>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });

                if (window.feather && typeof feather.replace === 'function') feather.replace();
            }

            function renderLatestTracks() {
                const container = document.getElementById('latest-tracks');
                container.innerHTML = '';

                if (latestTracks.length === 0) {
                    container.innerHTML = '<div class="text-center text-sm opacity-75 py-8">Aucun titre trouvÃ©</div>';
                    return;
                }

                latestTracks.forEach(track => {
                    const div = document.createElement('div');
                    div.className = 'glass-card rounded-xl p-4 flex items-center space-x-3';
                    div.setAttribute('data-aos', 'fade-up');
                    div.setAttribute('data-id', track.id);

                    const isLiked = musicLikes[track.id]?.liked || false;

                    div.innerHTML = `
                        <img src="${escapeHtml(track.cover_url || track.profiles?.avatar_url || 'images/default-profil.jpg')}" alt="Artiste" class="w-12 h-12 rounded-full">
                        <div class="flex-1">
                            <h3 class="font-medium">${escapeHtml(track.title)}</h3>
                            <p class="text-xs opacity-75">${escapeHtml(track.artist)} â€¢ ${escapeHtml(track.genre || 'Musique')} â€¢ ${escapeHtml(track.duration || '')}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="like-btn flex items-center text-dark-accent" data-id="${track.id}" title="J'aime">
                                <i data-feather="heart" class="w-4 h-4"></i><span class="ml-1 text-xs like-count">${track.likes_count || 0}</span>
                            </button>
                            <button class="w-10 h-10 rounded-full bg-dark-secondary bg-opacity-30 flex items-center justify-center play-btn" data-audio="${escapeHtml(track.audio_url || '')}">
                                <i data-feather="play" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });

                if (window.feather && typeof feather.replace === 'function') feather.replace();
            }

            // Gestion des likes pour la musique
            async function toggleMusicLike(musicId, element) {
                if (!currentUser) {
                    alert('Veuillez vous connecter pour liker');
                    return;
                }

                try {
                    const isLiked = musicLikes[musicId]?.liked || false;

                    if (isLiked) {
                        // Retirer le like
                        const { error } = await supabaseClient
                            .from('music_likes')
                            .delete()
                            .eq('user_id', currentUser.id)
                            .eq('music_id', musicId);

                        if (error) throw error;

                        musicLikes[musicId] = { liked: false };
                        // Mettre Ã  jour le compteur
                        const { data: countData } = await supabaseClient
                            .from('music')
                            .select('likes_count')
                            .eq('id', musicId)
                            .single();

                        if (countData) {
                            const newCount = Math.max(0, (countData.likes_count || 0) - 1);
                            await supabaseClient
                                .from('music')
                                .update({ likes_count: newCount })
                                .eq('id', musicId);
                        }
                    } else {
                        // Ajouter le like
                        const { error } = await supabaseClient
                            .from('music_likes')
                            .insert({
                                user_id: currentUser.id,
                                music_id: musicId
                            });

                        if (error) throw error;

                        musicLikes[musicId] = { liked: true };
                        // Mettre Ã  jour le compteur
                        const { data: countData } = await supabaseClient
                            .from('music')
                            .select('likes_count')
                            .eq('id', musicId)
                            .single();

                        if (countData) {
                            const newCount = (countData.likes_count || 0) + 1;
                            await supabaseClient
                                .from('music')
                                .update({ likes_count: newCount })
                                .eq('id', musicId);
                        }
                    }

                    // Recharger les donnÃ©es et mettre Ã  jour l'affichage
                    await loadMusicData();
                    renderFeaturedTrack();
                    renderPopularArtists();
                    renderLatestTracks();
                    renderAllPublished();

                } catch (error) {
                    console.error('Erreur lors du toggle like:', error);
                    // Fallback vers localStorage
                    toggleLike(musicId, element);
                }
            }

            // Variables de compatibilitÃ©
            let likes = loadJson(KEY_LIKES, {}); // Pour la compatibilitÃ©
            let tracks = loadJson(KEY_TRACKS, []); // Pour la compatibilitÃ©
            let playlists = loadJson(KEY_PLAYLISTS, []); // Pour la compatibilitÃ©

            // utilities
            function escapeHtml(unsafe) {
                return String(unsafe)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            function genId(prefix = 'id') {
                return `${prefix}-${Date.now()}-${Math.floor(Math.random()*10000)}`;
            }

            // Render functions
            function renderTrackCard(track) {
                const wrapper = document.createElement('div');
                wrapper.className = 'glass-card rounded-xl p-3';
                wrapper.setAttribute('data-aos', 'fade-up');
                wrapper.setAttribute('data-id', track.id);

                const likeState = likes[track.id] || { liked: false, count: 0 };
                wrapper.innerHTML = `
                    <img src="${escapeHtml(track.cover)}" alt="${escapeHtml(track.title)}" class="w-full rounded-lg mb-2">
                    <h3 class="font-medium text-sm">${escapeHtml(track.title)}</h3>
                    <p class="text-xs opacity-75">${escapeHtml(track.artist)} ${track.genre ? 'â€¢ ' + escapeHtml(track.genre) : ''}${track.duration ? ' â€¢ ' + escapeHtml(track.duration) : ''}</p>
                    <div class="flex justify-between items-center mt-3">
                        <div class="text-xs opacity-75">Statut: PubliÃ©</div>
                        <div class="flex items-center space-x-2">
                            <button class="w-9 h-9 rounded-full bg-dark-secondary bg-opacity-30 flex items-center justify-center play-toggle" title="Jouer">
                                <i data-feather="play" class="w-4 h-4"></i>
                            </button>
                            <button class="like-btn flex items-center text-dark-accent" data-id="${track.id}" title="J'aime">
                                <i data-feather="${likeState.liked ? 'heart' : 'heart'}" class="w-4 h-4"></i>
                                <span class="ml-1 text-xs like-count">${likeState.count || 0}</span>
                            </button>
                            <button class="text-yellow-300 add-to-playlist" data-id="${track.id}" title="Ajouter Ã  une playlist">
                                <i data-feather="plus-square" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-400 remove-btn" title="Supprimer" data-id="${track.id}">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                // attach behaviors after insert
                publishedContainer.prepend(wrapper);
                if (window.feather && typeof feather.replace === 'function') feather.replace();
                if (window.AOS && typeof AOS.refresh === 'function') AOS.refresh();

                // listeners
                const removeBtn = wrapper.querySelector('.remove-btn');
                removeBtn && removeBtn.addEventListener('click', () => {
                    wrapper.remove();
                    // remove from storage
                    tracks = tracks.filter(t => t.id !== track.id);
                    saveJson(KEY_TRACKS, tracks);
                });

                const playToggle = wrapper.querySelector('.play-toggle');
                playToggle && playToggle.addEventListener('click', () => {
                    const icon = playToggle.querySelector('i');
                    if (!icon) return;
                    const name = icon.getAttribute('data-feather') === 'play' ? 'pause' : 'play';
                    icon.setAttribute('data-feather', name);
                    if (window.feather && typeof feather.replace === 'function') feather.replace();
                });

                const likeBtn = wrapper.querySelector('.like-btn');
                likeBtn && likeBtn.addEventListener('click', () => toggleLike(track.id, likeBtn));

                const addToPlaylistBtn = wrapper.querySelector('.add-to-playlist');
                addToPlaylistBtn && addToPlaylistBtn.addEventListener('click', () => handleAddToPlaylist(track.id));
            }

            function renderAllPublished() {
                publishedContainer.innerHTML = '';
                // render stored tracks
                tracks.slice().reverse().forEach(renderTrackCard); // newest first
            }

            // Likes management
            function toggleLike(id, element) {
                if (!likes[id]) likes[id] = { liked: false, count: 0 };
                const entry = likes[id];
                entry.liked = !entry.liked;
                entry.count = Math.max(0, entry.count + (entry.liked ? 1 : -1));
                saveJson(KEY_LIKES, likes);
                // update UI
                updateLikeButtonUI(id, element);
            }
            function updateLikeButtonUI(id, element) {
                // element may be the button, or we locate any button with data-id
                const el = element || document.querySelector(`.like-btn[data-id="${id}"]`);
                if (!el) return;
                const icon = el.querySelector('i');
                const countSpan = el.querySelector('.like-count');
                if (icon) icon.setAttribute('data-feather', likes[id] && likes[id].liked ? 'heart' : 'heart');
                if (countSpan) countSpan.textContent = (likes[id] && (likes[id].count || 0)) + '';
                if (window.feather && typeof feather.replace === 'function') feather.replace();
            }
            function applyLikesToPage() {
                document.querySelectorAll('.like-btn').forEach(btn => {
                    const id = btn.getAttribute('data-id');
                    if (!id) return;
                    if (!likes[id]) likes[id] = { liked: false, count: 0 };
                    const countSpan = btn.querySelector('.like-count');
                    if (countSpan) countSpan.textContent = likes[id].count || 0;
                    // ensure icon exists; icons are updated via feather.replace
                });
            }

            // Playlists management
            function renderPlaylists() {
                playlistsContainer.innerHTML = '';
                if (!playlists.length) {
                    playlistsContainer.innerHTML = '<div class="text-sm opacity-75">Aucune playlist crÃ©Ã©e.</div>';
                    return;
                }
                playlists.forEach(pl => {
                    const div = document.createElement('div');
                    div.className = 'glass-card rounded-lg p-3 flex items-center justify-between';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium">${escapeHtml(pl.name)}</div>
                            <div class="text-xs opacity-75">${pl.tracks.length} morceau(s)</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="view-pl-btn px-3 py-1 rounded-full bg-dark-secondary bg-opacity-30" data-id="${pl.id}">Voir</button>
                            <button class="clear-pl-btn text-yellow-300" data-id="${pl.id}" title="Vider la playlist"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            <button class="delete-pl-btn text-red-400" data-id="${pl.id}" title="Supprimer"><i data-feather="x" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    playlistsContainer.appendChild(div);
                    // listeners
                    div.querySelector('.view-pl-btn').addEventListener('click', () => {
                        showPlaylistDetails(pl.id);
                    });
                    div.querySelector('.clear-pl-btn').addEventListener('click', () => {
                        if (confirm(`Vider la playlist "${pl.name}" ?`)) {
                            pl.tracks = [];
                            saveJson(KEY_PLAYLISTS, playlists);
                            renderPlaylists();
                        }
                    });
                    div.querySelector('.delete-pl-btn').addEventListener('click', () => {
                        if (confirm(`Supprimer la playlist "${pl.name}" ?`)) {
                            playlists = playlists.filter(p => p.id !== pl.id);
                            saveJson(KEY_PLAYLISTS, playlists);
                            renderPlaylists();
                        }
                    });
                });
                if (window.feather && typeof feather.replace === 'function') feather.replace();
            }

            function showPlaylistDetails(playlistId) {
                const pl = playlists.find(p => p.id === playlistId);
                if (!pl) return alert('Playlist introuvable');
                // modal-like simple UI using prompt: display tracks and option to remove individually
                if (!pl.tracks.length) return alert(`"${pl.name}" est vide.`);
                let msg = `Playlist: ${pl.name}\nMorceaux:\n`;
                pl.tracks.forEach((tid, idx) => {
                    const t = tracks.find(tt => tt.id === tid);
                    msg += `${idx+1}. ${t ? t.title + ' â€” ' + t.artist : '(non trouvÃ©)'}\n`;
                });
                alert(msg);
            }

            function handleAddToPlaylist(trackId) {
                if (!playlists.length) return alert('Aucune playlist. CrÃ©ez d\'abord une playlist.');
                // show numbered list and ask for index
                let promptMsg = 'Choisissez une playlist (entrez le numÃ©ro):\n';
                playlists.forEach((p, i) => promptMsg += `${i+1}. ${p.name}\n`);
                const choice = prompt(promptMsg);
                if (!choice) return;
                const idx = parseInt(choice, 10) - 1;
                if (isNaN(idx) || idx < 0 || idx >= playlists.length) return alert('Choix invalide.');
                const pl = playlists[idx];
                if (!pl.tracks.includes(trackId)) {
                    pl.tracks.push(trackId);
                    saveJson(KEY_PLAYLISTS, playlists);
                    alert(`AjoutÃ© Ã  "${pl.name}"`);
                    renderPlaylists();
                } else {
                    alert('Le morceau est dÃ©jÃ  dans la playlist.');
                }
            }

            // Form handlers
            if (form && publishedContainer) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!currentUser) {
                        if (feedback) feedback.textContent = 'Veuillez vous connecter pour publier de la musique.';
                        return;
                    }

                    const title = (document.getElementById('music-title') || {}).value || '';
                    const artist = (document.getElementById('music-artist') || {}).value || '';
                    const cover = (document.getElementById('music-cover') || {}).value || '';
                    const duration = (document.getElementById('music-duration') || {}).value || '';
                    const genre = (document.getElementById('music-genre') || {}).value || '';

                    if (!title.trim() || !artist.trim()) {
                        if (feedback) feedback.textContent = 'Titre et artiste sont requis.';
                        return;
                    }

                    try {
                        // CrÃ©er le track dans la base de donnÃ©es
                        const { data: track, error } = await supabaseClient
                            .from('music')
                            .insert({
                                title: title.trim(),
                                artist: artist.trim(),
                                cover_url: cover.trim() || null,
                                duration: duration.trim() || null,
                                genre: genre || null,
                                author_id: currentUser.id
                            })
                            .select()
                            .single();

                        if (error) throw error;

                        // Recharger les donnÃ©es
                        await loadMusicData();
                        renderAllPublished();
                        renderLatestTracks();

                        // feedback
                        if (feedback) {
                            feedback.textContent = `Le morceau "${title}" par ${artist} a Ã©tÃ© publiÃ© avec succÃ¨s !`;
                            setTimeout(() => feedback.textContent = '', 4000);
                        }

                        // clear certains champs pour confort
                        (document.getElementById('music-title') || {}).value = '';
                        (document.getElementById('music-file') || {}).value = '';
                        (document.getElementById('music-cover') || {}).value = '';
                        (document.getElementById('music-duration') || {}).value = '';
                        (document.getElementById('music-artist') || {}).value = '';
                        (document.getElementById('music-genre') || {}).value = '';

                    } catch (error) {
                        console.error('Erreur lors de la publication:', error);
                        if (feedback) {
                            feedback.textContent = 'Erreur lors de la publication. Veuillez rÃ©essayer.';
                        }
                    }
                });
            }

            // Create playlist handler
            if (createPlaylistForm) {
                createPlaylistForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = (document.getElementById('playlist-name') || {}).value || '';
                    if (!name.trim()) return alert('Nom invalide');
                    const pl = { id: genId('pl'), name: name.trim(), tracks: [] };
                    playlists.push(pl);
                    saveJson(KEY_PLAYLISTS, playlists);
                    renderPlaylists();
                    (document.getElementById('playlist-name') || {}).value = '';
                });
            }

            // Modal open/close logic pour le bouton Publier / Playlists
            const openBtn = document.getElementById('open-publish-btn');
            const modal = document.getElementById('publish-modal');
            const closeBtn = document.getElementById('close-publish-btn');

            // Logique de recherche
            const searchToggleBtn = document.getElementById('search-toggle-btn');
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const searchClearBtn = document.getElementById('search-clear-btn');
            const searchResults = document.getElementById('search-results');

            function openModal() {
                if (!modal) return;
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                // refresh icons inside modal
                if (window.feather && typeof feather.replace === 'function') feather.replace();
                // refresh AOS in case elements are animated
                if (window.AOS && typeof AOS.refresh === 'function') AOS.refresh();
            }
            function closeModal() {
                if (!modal) return;
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
            }
            if (openBtn) openBtn.addEventListener('click', openModal);
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            // close on overlay click (but ignore clicks inside panel)
            if (modal) {
                modal.addEventListener('click', (ev) => {
                    if (ev.target === modal) closeModal();
                });
            }
            // close on Escape
            document.addEventListener('keydown', (ev) => {
                if (ev.key === 'Escape') {
                    closeModal();
                    // Aussi fermer la recherche si elle est ouverte
                    if (searchContainer && !searchContainer.classList.contains('hidden')) {
                        toggleSearch(false);
                    }
                }
            });

            // Fonctions de recherche
            function toggleSearch(show = null) {
                if (!searchContainer) return;
                const isCurrentlyVisible = !searchContainer.classList.contains('hidden');
                const shouldShow = show !== null ? show : !isCurrentlyVisible;
                
                if (shouldShow) {
                    searchContainer.classList.remove('hidden');
                    if (searchInput) {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                } else {
                    searchContainer.classList.add('hidden');
                    if (searchInput) searchInput.value = '';
                    if (searchResults) searchResults.classList.add('hidden');
                }
            }

            function performSearch(query) {
                if (!searchResults) return;
                
                const lowerQuery = query.toLowerCase().trim();
                if (!lowerQuery) {
                    searchResults.classList.add('hidden');
                    return;
                }

                // Recherche dans les donnÃ©es dynamiques chargÃ©es
                const searchableItems = [];

                // Ajouter les tracks publiÃ©es
                tracks.forEach(track => {
                    searchableItems.push({
                        type: 'published',
                        title: track.title,
                        subtitle: track.artist + (track.genre ? ' â€¢ ' + track.genre : '') + (track.duration ? ' â€¢ ' + track.duration : ''),
                        artist: track.artist,
                        genre: track.genre
                    });
                });

                // Ajouter les tracks du featured si visible
                if (featuredTrack) {
                    searchableItems.push({
                        type: 'featured',
                        title: featuredTrack.title,
                        subtitle: featuredTrack.artist + ' â€¢ ' + (featuredTrack.genre || 'Musique') + ' â€¢ ' + (featuredTrack.duration || ''),
                        artist: featuredTrack.artist,
                        genre: featuredTrack.genre
                    });
                }

                // Ajouter les artistes populaires
                popularArtists.forEach(artist => {
                    searchableItems.push({
                        type: 'artist',
                        title: artist.name,
                        subtitle: (artist.genre || 'Musique') + ' â€¢ ' + (artist.trackCount || 0) + ' titres',
                        artist: artist.name,
                        genre: artist.genre
                    });
                });

                // Ajouter les nouveaux tracks
                latestTracks.forEach(track => {
                    searchableItems.push({
                        type: 'track',
                        title: track.title,
                        subtitle: track.artist + ' â€¢ ' + (track.genre || 'Musique') + ' â€¢ ' + (track.duration || ''),
                        artist: track.artist,
                        genre: track.genre
                    });
                });

                // Recherche aussi dans les tracks publiÃ©es
                const publishedResults = tracks.filter(track => 
                    track.title.toLowerCase().includes(lowerQuery) || 
                    track.artist.toLowerCase().includes(lowerQuery) ||
                    (track.genre && track.genre.toLowerCase().includes(lowerQuery))
                ).map(track => ({
                    type: 'published',
                    title: track.title,
                    subtitle: track.artist + (track.genre ? ' â€¢ ' + track.genre : '') + (track.duration ? ' â€¢ ' + track.duration : ''),
                    artist: track.artist
                }));

                // Filtrer les rÃ©sultats statiques
                const staticResults = searchableItems.filter(item => 
                    item.title.toLowerCase().includes(lowerQuery) || 
                    item.artist.toLowerCase().includes(lowerQuery) ||
                    item.subtitle.toLowerCase().includes(lowerQuery)
                );

                const allResults = [...staticResults, ...publishedResults];

                if (allResults.length === 0) {
                    searchResults.innerHTML = '<div class="text-sm opacity-75 p-3">Aucun rÃ©sultat trouvÃ© pour "' + escapeHtml(query) + '"</div>';
                } else {
                    const resultsHTML = allResults.map(result => `
                        <div class="glass-card rounded-lg p-3 flex items-center space-x-3 hover:bg-white/5 cursor-pointer search-result-item" 
                             data-type="${result.type}" data-title="${escapeHtml(result.title)}">
                            <div class="w-10 h-10 rounded-full bg-dark-secondary bg-opacity-30 flex items-center justify-center">
                                <i data-feather="${result.type === 'track' || result.type === 'featured' ? 'music' : (result.type === 'artist' ? 'user' : 'play')}" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-sm">${escapeHtml(result.title)}</h4>
                                <p class="text-xs opacity-75">${escapeHtml(result.subtitle)}</p>
                            </div>
                            <div class="text-xs opacity-50 uppercase">${escapeHtml(result.type)}</div>
                        </div>
                    `).join('');
                    searchResults.innerHTML = resultsHTML;

                    // Ajouter les Ã©couteurs d'Ã©vÃ©nements aux rÃ©sultats
                    searchResults.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const title = item.getAttribute('data-title');
                            alert(`Lecture de: ${title}\n(FonctionnalitÃ© de lecture Ã  implÃ©menter)`);
                        });
                    });
                }

                searchResults.classList.remove('hidden');
                // Refresh feather icons in search results
                if (window.feather && typeof feather.replace === 'function') {
                    feather.replace();
                }
            }

            // Event listeners pour la recherche
            if (searchToggleBtn) {
                searchToggleBtn.addEventListener('click', () => toggleSearch());
            }

            if (searchClearBtn) {
                searchClearBtn.addEventListener('click', () => {
                    if (searchInput) searchInput.value = '';
                    if (searchResults) searchResults.classList.add('hidden');
                });
            }

            if (searchInput) {
                // Recherche en temps rÃ©el avec debounce
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch(e.target.value);
                    }, 300);
                });

                // Recherche sur Enter
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        clearTimeout(searchTimeout);
                        performSearch(e.target.value);
                    }
                });
            }

            // Initialize page with dynamic data
            async function init() {
                try {
                    // Charger les donnÃ©es depuis Supabase
                    await loadMusicData();

                    // Rendre tous les Ã©lÃ©ments dynamiques
                    renderFeaturedTrack();
                    renderPopularArtists();
                    renderLatestTracks();
                    renderAllPublished();
                    renderPlaylists();

                    // Attacher les Ã©couteurs d'Ã©vÃ©nements pour les likes
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('.like-btn')) {
                            const btn = e.target.closest('.like-btn');
                            const id = btn.getAttribute('data-id');
                            if (id) {
                                toggleMusicLike(id, btn);
                            }
                        }
                    });

                    // Attacher les Ã©couteurs pour les boutons play
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('.play-btn')) {
                            const btn = e.target.closest('.play-btn');
                            const audioUrl = btn.getAttribute('data-audio');
                            if (audioUrl) {
                                // TODO: ImplÃ©menter la lecture audio
                                alert('Lecture audio Ã  implÃ©menter: ' + audioUrl);
                            }
                        }
                    });

                    // refresh icons
                    if (window.feather && typeof feather.replace === 'function') feather.replace();

                } catch (error) {
                    console.error('Erreur lors de l\'initialisation:', error);
                    // Fallback vers l'ancien systÃ¨me
                    renderAllPublished();
                    applyLikesToPage();
                    renderPlaylists();
                }
            }

            // Initialiser la page
            init();

            // expose for debugging if needed
            window.__echoes = { likes, tracks, playlists, supabaseClient, currentUser, featuredTrack, popularArtists, latestTracks, musicLikes };

        });
    </script>
<script src="user-badge-display.js"></script>
<script src="dynamic-interactions.js"></script>
<script src="badge-system.js"></script>
</body>
</html>