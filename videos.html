<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHOES - Vidéos</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        :root {
            --nav-height: 80px; 
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        body {
            background-color: #000;
        }
        .feed {
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .feed::-webkit-scrollbar {
            display: none;
        }
        .video-item {
            height: 100%;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-item video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        .video-overlay {
            z-index: 2;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }
        .video-actions {
            z-index: 2;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-size: 0.8rem;
            gap: 0.25rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 to-black text-white flex justify-center items-center">

<div class="relative w-full h-screen overflow-hidden bg-black shadow-2xl">
    <!-- Main Content -->
    <div class="feed h-full">
        <!-- Videos will be loaded dynamically here -->
    </div>
</div>

    <script>
        feather.replace();

        // Global variables for video management
        let currentObserver = null;
        let loadedVideoIds = new Set();
        let isLoadingMore = false;
        let hasMoreVideos = true;
        let currentPage = 0;
        const VIDEOS_PER_PAGE = 10;

        // Function to load video posts from database
        async function loadVideoPosts(page = 0, limit = VIDEOS_PER_PAGE) {
            try {
                const supabase = await window.getSupabase();
                const { data: posts, error } = await supabase
                    .from('posts')
                    .select('*, author:profiles(id, full_name, username, avatar_url, thought, badge), tags')
                    .not('video_url', 'is', null)
                    .order('created_at', { ascending: false })
                    .range(page * limit, (page + 1) * limit - 1);

                if (error) throw error;
                return posts || [];
            } catch (error) {
                console.error('Error loading video posts:', error);
                return [];
            }
        }

        // Function to render a video post
        async function renderVideoPost(post) {
            const authorName = post.author?.full_name || post.author?.username || 'Utilisateur';
            const avatar = post.author?.avatar_url || 'http://static.photos/people/200x200/1';
            const authorId = post.author?.id || post.author_id;

            const timeAgo = formatTimeAgo(new Date(post.created_at));

            // Get real interaction counts
            let likesCount = 0;
            let commentsCount = 0;
            let isLiked = false;
            let isFollowing = false;

            try {
                if (window.echoesInteractions) {
                    [likesCount, commentsCount, isLiked, isFollowing] = await Promise.all([
                        window.echoesInteractions.getLikesCount(post.id),
                        window.echoesInteractions.getCommentsCount(post.id),
                        window.echoesInteractions.isLiked(post.id),
                        authorId ? window.echoesInteractions.isFollowing(authorId) : Promise.resolve(false)
                    ]);
                }
            } catch (e) {
                console.warn('[DEBUG renderVideoPost] Error loading counters for video post', post.id, ':', e);
            }

            const likedClass = isLiked ? 'text-red-500' : '';
            const likedFill = isLiked ? 'fill="currentColor"' : '';

            const followBtnClass = isFollowing ? 'bg-dark-accent text-white' : '';
            const followIcon = isFollowing ? 'user-check' : 'user-plus';
            const followText = isFollowing ? 'Abonné' : "S'abonner";

            const card = document.createElement('div');
            card.className = 'video-item';
            card.dataset.postId = post.id;

            card.innerHTML = `
                <video poster="${post.image_url || ''}" playsinline muted loop preload="metadata" data-video-url="${post.video_url}">
                    <source src="${post.video_url}" type="video/mp4">
                </video>
                <div class="absolute top-4 right-4 z-30">
                    <a href="index.html" class="p-2 bg-gray-800 bg-opacity-50 rounded-full">
                        <i data-feather="home" class="w-5 h-5 text-white"></i>
                    </a>
                </div>
                <div class="video-overlay">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <img src="${avatar}" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white">
                            <h3 class="font-bold video-author-name">${escapeHtml(authorName)}</h3>
                            <button class="px-3 py-1 text-xs rounded-full bg-white text-black font-semibold follow-btn ${followBtnClass}" data-action="follow" data-user-id="${authorId}">
                                <i data-feather="${followIcon}" class="w-3 h-3"></i>
                                <span>${followText}</span>
                            </button>
                        </div>
                        <p class="text-sm">${escapeHtml(post.content || '')}</p>
                        <p class="text-xs mt-1 opacity-80">♫ Original Audio</p>
                    </div>
                </div>
                <div class="video-actions">
                    <button class="action-button like-btn ${likedClass}" data-action="like" data-post-id="${post.id}">
                        <i data-feather="heart" class="w-7 h-7" ${likedFill}></i>
                        <span>${likesCount}</span>
                    </button>
                    <button class="action-button comment-btn" data-action="comment" data-post-id="${post.id}">
                        <i data-feather="message-square" class="w-7 h-7"></i>
                        <span>${commentsCount}</span>
                    </button>
                    <button class="action-button share-btn" data-action="share" data-post-id="${post.id}" data-post-content="${escapeHtml(post.content || '')}">
                        <i data-feather="send" class="w-7 h-7"></i>
                    </button>
                    <button class="action-button">
                        <i data-feather="bookmark" class="w-7 h-7"></i>
                    </button>
                    <button class="action-button download-btn" data-post-id="${post.id}">
                        <i data-feather="download" class="w-7 h-7"></i>
                    </button>
                </div>
            `;

            return card;
        }

        // Function to format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' an' + (Math.floor(interval) > 1 ? 's' : '');

            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' mois';

            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' jour' + (Math.floor(interval) > 1 ? 's' : '');

            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' heure' + (Math.floor(interval) > 1 ? 's' : '');

            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' minute' + (Math.floor(interval) > 1 ? 's' : '');

            return 'À l\'instant';
        }

        // Function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to setup video observer for autoplay/pause
        function setupVideoObserver() {
            const feed = document.querySelector('.feed');
            if (!feed) return;

            // Disconnect previous observer
            if (currentObserver) {
                currentObserver.disconnect();
            }

            const videos = feed.querySelectorAll('video');
            const observerOptions = {
                root: feed,
                threshold: 0.65
            };

            currentObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const v = entry.target;
                    if (entry.isIntersecting) {
                        v.play().catch(() => {});
                    } else {
                        v.pause();
                    }
                });
            }, observerOptions);

            videos.forEach(v => {
                currentObserver.observe(v);
                v.pause();
            });
        }

        // Function to load more videos (infinite scroll)
        async function loadMoreVideos() {
            if (isLoadingMore || !hasMoreVideos) return;

            isLoadingMore = true;
            const feed = document.querySelector('.feed');
            if (!feed) return;

            try {
                const videos = await loadVideoPosts(currentPage + 1, VIDEOS_PER_PAGE);
                if (videos.length === 0) {
                    hasMoreVideos = false;
                    return;
                }

                // Filter out already loaded videos
                const newVideos = videos.filter(video => !loadedVideoIds.has(video.id));
                newVideos.forEach(video => loadedVideoIds.add(video.id));

                // Append new videos
                for (const video of newVideos) {
                    const videoEl = await renderVideoPost(video);
                    feed.appendChild(videoEl);
                }

                currentPage++;

                // Re-setup observer for new videos
                setupVideoObserver();

                // Re-initialize feather icons for new elements
                if (window.feather) feather.replace();

                // Update interaction counters for new videos
                updateVideoCounters(newVideos);

            } catch (error) {
                console.error('Error loading more videos:', error);
            } finally {
                isLoadingMore = false;
            }
        }

        // Function to initialize videos page
        async function initVideosPage() {
            const feed = document.querySelector('.feed');
            if (!feed) return;

            try {
                // Load initial videos
                const videos = await loadVideoPosts(0, VIDEOS_PER_PAGE);
                videos.forEach(video => loadedVideoIds.add(video.id));

                // Clear existing content and add new videos
                feed.innerHTML = '';

                if (videos.length === 0) {
                    feed.innerHTML = '<div class="text-center text-white p-8">Aucune vidéo disponible pour le moment.</div>';
                    return;
                }

                for (const video of videos) {
                    const videoEl = await renderVideoPost(video);
                    feed.appendChild(videoEl);
                }

                // Setup video observer
                setupVideoObserver();

                // Setup infinite scroll
                const observerOptions = {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0.1
                };

                const infiniteScrollObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            loadMoreVideos();
                        }
                    });
                }, observerOptions);

                // Create a sentinel element for infinite scroll
                const sentinel = document.createElement('div');
                sentinel.className = 'sentinel';
                sentinel.style.height = '1px';
                feed.appendChild(sentinel);
                infiniteScrollObserver.observe(sentinel);

            } catch (error) {
                console.error('Error initializing videos page:', error);
                feed.innerHTML = '<div class="text-center text-white p-8">Erreur lors du chargement des vidéos</div>';
            }
        }

        // Function to update counters for video posts
        async function updateVideoCounters(videos) {
            if (!videos || !window.echoesInteractions) return;

            for (const video of videos) {
                try {
                    const [likesCount, commentsCount] = await Promise.all([
                        window.echoesInteractions.getLikesCount(video.id),
                        window.echoesInteractions.getCommentsCount(video.id)
                    ]);

                    // Update like counter
                    const likeBtn = document.querySelector(`[data-action="like"][data-post-id="${video.id}"] span`);
                    if (likeBtn) likeBtn.textContent = likesCount;

                    // Update comment counter
                    const commentBtn = document.querySelector(`[data-action="comment"][data-post-id="${video.id}"] span`);
                    if (commentBtn) commentBtn.textContent = commentsCount;
                } catch (e) {
                    console.warn('Error updating counters for video', video.id, e);
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initVideosPage();
        });
    </script>
<script src="supabase-config.js"></script>
<script src="supabase-client.js"></script>
<script src="interactions.js"></script>
<script src="badge-injector.js"></script>
<script src="user-badge-display.js"></script>
<script src="dynamic-interactions.js"></script>
<script src="badge-system.js"></script>
<script src="background-init.js"></script>
</body>
</html>
