<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHOES - Vidéos</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        :root {
            --nav-height: 80px; 
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        body {
            background-color: #000;
        }
        .feed {
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .feed::-webkit-scrollbar {
            display: none;
        }
        .video-item {
            height: 100vh;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-item video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Changed from cover to contain to maintain aspect ratio */
            z-index: 1;
        }

        /* Responsive video sizing for different screen sizes */
        @media (max-width: 640px) {
            .video-item {
                height: 100vh;
            }
            .video-item video {
                object-fit: cover; /* Use cover on mobile for better UX */
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .video-item {
                height: 100vh;
            }
            .video-item video {
                object-fit: contain;
                max-width: 90vw;
                max-height: 80vh;
            }
        }

        @media (min-width: 1025px) {
            .video-item {
                height: 100vh;
            }
            .video-item video {
                object-fit: contain;
                max-width: 80vw;
                max-height: 70vh;
            }
        }
        .video-overlay {
            z-index: 2;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }

        /* Responsive overlay adjustments */
        @media (max-width: 640px) {
            .video-overlay {
                padding: 1rem;
            }
        }

        .video-actions {
            z-index: 2;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* Responsive action buttons */
        @media (max-width: 640px) {
            .video-actions {
                right: 0.5rem;
                gap: 0.75rem;
                top: 60%;
            }
            .action-button {
                font-size: 0.65rem;
                gap: 0.15rem;
            }
        }

        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-size: 0.8rem;
            gap: 0.25rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 to-black text-white flex justify-center items-center">

<div class="relative w-full h-screen overflow-hidden bg-black shadow-2xl">
    <!-- Main Content -->
    <div class="feed h-full">
        <!-- Videos will be loaded dynamically here -->
    </div>
</div>

    <script>
        feather.replace();

        // Global variables for video management
        let currentObserver = null;
        let loadedVideoIds = new Set();
        let isLoadingMore = false;
        let hasMoreVideos = true;
        let currentPage = 0;
        const VIDEOS_PER_PAGE = 10;

        // Function to load video posts from database
        async function loadVideoPosts(page = 0, limit = VIDEOS_PER_PAGE) {
            try {
                const supabase = await window.getSupabase();
                const { data: posts, error } = await supabase
                    .from('posts')
                    .select('*, author:profiles(id, full_name, username, avatar_url, thought, badge), tags')
                    .not('video_url', 'is', null)
                    .order('created_at', { ascending: false })
                    .range(page * limit, (page + 1) * limit - 1);

                if (error) throw error;
                return posts || [];
            } catch (error) {
                console.error('Error loading video posts:', error);
                return [];
            }
        }

        // Function to render a video post
        async function renderVideoPost(post) {
            const authorName = post.author?.full_name || post.author?.username || 'Utilisateur';
            const avatar = post.author?.avatar_url || 'http://static.photos/people/200x200/1';
            const authorId = post.author?.id || post.author_id;

            const timeAgo = formatTimeAgo(new Date(post.created_at));

            // Get real interaction counts
            let likesCount = 0;
            let commentsCount = 0;
            let viewsCount = 0;
            let isLiked = false;
            let isFollowing = false;

            try {
                if (window.echoesInteractions) {
                    [likesCount, commentsCount, isLiked, isFollowing] = await Promise.all([
                        window.echoesInteractions.getLikesCount(post.id),
                        window.echoesInteractions.getCommentsCount(post.id),
                        window.echoesInteractions.isLiked(post.id),
                        authorId ? window.echoesInteractions.isFollowing(authorId) : Promise.resolve(false)
                    ]);
                }

                // Get views count
                viewsCount = await getVideoViewsCount(post.id);
            } catch (e) {
                console.warn('[DEBUG renderVideoPost] Error loading counters for video post', post.id, ':', e);
            }

            const likedClass = isLiked ? 'text-red-500' : '';
            const likedFill = isLiked ? 'fill="currentColor"' : '';

            const followBtnClass = isFollowing ? 'bg-dark-accent text-white' : '';
            const followIcon = isFollowing ? 'user-check' : 'user-plus';
            const followText = isFollowing ? 'Abonné' : "S'abonner";

            const card = document.createElement('div');
            card.className = 'video-item';
            card.dataset.postId = post.id;

            card.innerHTML = `
                <video poster="${post.image_url || ''}" playsinline loop preload="metadata" data-video-url="${post.video_url}">
                    <source src="${post.video_url}" type="video/mp4">
                </video>
                <div class="absolute top-4 right-4 z-30">
                    <a href="index.html" class="p-2 bg-gray-800 bg-opacity-50 rounded-full">
                        <i data-feather="home" class="w-5 h-5 text-white"></i>
                    </a>
                </div>
                <div class="video-overlay">
                    <div class="w-full max-w-md">
                        <div class="flex items-center gap-2 mb-2">
                            <img src="${avatar}" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white">
                            <h3 class="font-bold video-author-name text-sm sm:text-base">${escapeHtml(authorName)}</h3>
                            <button class="px-2 py-1 sm:px-3 sm:py-1 text-xs rounded-full bg-white text-black font-semibold follow-btn ${followBtnClass}" data-action="follow" data-user-id="${authorId}">
                                <i data-feather="${followIcon}" class="w-3 h-3"></i>
                                <span class="hidden sm:inline">${followText}</span>
                            </button>
                        </div>
                        <p class="text-sm line-clamp-2">${escapeHtml(post.content || '')}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <p class="text-xs opacity-80">♫ Original Audio</p>
                            <span class="text-xs opacity-60">•</span>
                            <span class="text-xs opacity-80 flex items-center gap-1">
                                <i data-feather="eye" class="w-3 h-3"></i>
                                ${formatViewsCount(viewsCount)}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="video-actions">
                    <button class="action-button like-btn ${likedClass}" data-action="like" data-post-id="${post.id}" title="Aimer">
                        <i data-feather="heart" class="w-6 h-6 sm:w-7 sm:h-7" ${likedFill}></i>
                        <span class="text-xs">${likesCount}</span>
                    </button>
                    <button class="action-button comment-btn" data-action="comment" data-post-id="${post.id}" title="Commenter">
                        <i data-feather="message-square" class="w-6 h-6 sm:w-7 sm:h-7"></i>
                        <span class="text-xs">${commentsCount}</span>
                    </button>
                    <button class="action-button share-btn" data-action="share" data-post-id="${post.id}" data-post-content="${escapeHtml(post.content || '')}" title="Partager">
                        <i data-feather="send" class="w-6 h-6 sm:w-7 sm:h-7"></i>
                    </button>
                    <button class="action-button bookmark-btn" data-action="bookmark" data-post-id="${post.id}" title="Sauvegarder">
                        <i data-feather="bookmark" class="w-6 h-6 sm:w-7 sm:h-7"></i>
                    </button>
                    <button class="action-button download-btn" data-post-id="${post.id}" title="Télécharger">
                        <i data-feather="download" class="w-6 h-6 sm:w-7 sm:h-7"></i>
                    </button>
                </div>
            `;

            return card;
        }

        // Function to format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' an' + (Math.floor(interval) > 1 ? 's' : '');

            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' mois';

            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' jour' + (Math.floor(interval) > 1 ? 's' : '');

            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' heure' + (Math.floor(interval) > 1 ? 's' : '');

            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' minute' + (Math.floor(interval) > 1 ? 's' : '');

            return 'À l\'instant';
        }

        // Function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to get video views count
        async function getVideoViewsCount(postId) {
            try {
                const supabase = await window.getSupabase();
                // For now, we'll use a simple view counter based on post creation
                // In a real app, you'd have a separate views table
                const { data: post, error } = await supabase
                    .from('posts')
                    .select('created_at')
                    .eq('id', postId)
                    .single();

                if (error) throw error;

                // Calculate a pseudo-view count based on post age and some randomness
                const postDate = new Date(post.created_at);
                const now = new Date();
                const daysSincePost = Math.floor((now - postDate) / (1000 * 60 * 60 * 24));

                // Base views + some randomness + age factor
                const baseViews = Math.floor(Math.random() * 1000) + 500;
                const ageMultiplier = Math.min(daysSincePost * 10, 5000);

                return baseViews + ageMultiplier;
            } catch (error) {
                console.warn('Error getting views count:', error);
                return Math.floor(Math.random() * 100) + 50; // Fallback random number
            }
        }

        // Function to format views count
        function formatViewsCount(count) {
            if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'K';
            } else {
                return count.toString();
            }
        }

        // Function to setup video observer for autoplay/pause
        function setupVideoObserver() {
            const feed = document.querySelector('.feed');
            if (!feed) return;

            // Disconnect previous observer
            if (currentObserver) {
                currentObserver.disconnect();
            }

            const videos = feed.querySelectorAll('video');
            const observerOptions = {
                root: feed,
                threshold: 0.65
            };

            currentObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const v = entry.target;
                    if (entry.isIntersecting) {
                        // Enable sound and play
                        v.muted = false;
                        v.volume = 0.5; // Set moderate volume
                        v.play().catch(() => {
                            // If autoplay fails, mute and try again
                            v.muted = true;
                            v.play().catch(() => {});
                        });
                    } else {
                        v.pause();
                    }
                });
            }, observerOptions);

            videos.forEach(v => {
                currentObserver.observe(v);
                v.pause();
                v.muted = true; // Start muted to allow autoplay
            });
        }

        // Function to load more videos (infinite scroll)
        async function loadMoreVideos() {
            if (isLoadingMore || !hasMoreVideos) return;

            isLoadingMore = true;
            const feed = document.querySelector('.feed');
            if (!feed) return;

            try {
                const videos = await loadVideoPosts(currentPage + 1, VIDEOS_PER_PAGE);
                if (videos.length === 0) {
                    hasMoreVideos = false;
                    return;
                }

                // Filter out already loaded videos
                const newVideos = videos.filter(video => !loadedVideoIds.has(video.id));
                newVideos.forEach(video => loadedVideoIds.add(video.id));

                // Append new videos
                for (const video of newVideos) {
                    const videoEl = await renderVideoPost(video);
                    feed.appendChild(videoEl);
                }

                currentPage++;

                // Re-setup observer for new videos
                setupVideoObserver();

                // Re-initialize feather icons for new elements
                if (window.feather) feather.replace();

                // Update interaction counters for new videos
                updateVideoCounters(newVideos);

            } catch (error) {
                console.error('Error loading more videos:', error);
            } finally {
                isLoadingMore = false;
            }
        }

        // Function to initialize videos page
        async function initVideosPage() {
            const feed = document.querySelector('.feed');
            if (!feed) return;

            try {
                // Load initial videos
                const videos = await loadVideoPosts(0, VIDEOS_PER_PAGE);
                videos.forEach(video => loadedVideoIds.add(video.id));

                // Clear existing content and add new videos
                feed.innerHTML = '';

                if (videos.length === 0) {
                    feed.innerHTML = '<div class="text-center text-white p-8">Aucune vidéo disponible pour le moment.</div>';
                    return;
                }

                for (const video of videos) {
                    const videoEl = await renderVideoPost(video);
                    feed.appendChild(videoEl);
                }

                // Setup video observer
                setupVideoObserver();

                // Setup infinite scroll
                const observerOptions = {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0.1
                };

                const infiniteScrollObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            loadMoreVideos();
                        }
                    });
                }, observerOptions);

                // Create a sentinel element for infinite scroll
                const sentinel = document.createElement('div');
                sentinel.className = 'sentinel';
                sentinel.style.height = '1px';
                feed.appendChild(sentinel);
                infiniteScrollObserver.observe(sentinel);

            } catch (error) {
                console.error('Error initializing videos page:', error);
                feed.innerHTML = '<div class="text-center text-white p-8">Erreur lors du chargement des vidéos</div>';
            }
        }

        // Function to update counters for video posts
        async function updateVideoCounters(videos) {
            if (!videos || !window.echoesInteractions) return;

            for (const video of videos) {
                try {
                    const [likesCount, commentsCount] = await Promise.all([
                        window.echoesInteractions.getLikesCount(video.id),
                        window.echoesInteractions.getCommentsCount(video.id)
                    ]);

                    // Update like counter
                    const likeBtn = document.querySelector(`[data-action="like"][data-post-id="${video.id}"] span`);
                    if (likeBtn) likeBtn.textContent = likesCount;

                    // Update comment counter
                    const commentBtn = document.querySelector(`[data-action="comment"][data-post-id="${video.id}"] span`);
                    if (commentBtn) commentBtn.textContent = commentsCount;
                } catch (e) {
                    console.warn('Error updating counters for video', video.id, e);
                }
            }
        }

        // Function to handle video comments overlay
        function initVideoComments() {
            document.addEventListener('click', async (e) => {
                const commentBtn = e.target.closest('[data-action="comment"]');
                if (!commentBtn) return;

                e.preventDefault();
                const postId = commentBtn.dataset.postId;
                if (!postId) return;

                // Create or show comments overlay
                showVideoCommentsOverlay(postId);
            });
        }

        // Function to show comments overlay for videos
        async function showVideoCommentsOverlay(postId) {
            // Remove existing overlay if any
            const existingOverlay = document.querySelector('.video-comments-overlay');
            if (existingOverlay) existingOverlay.remove();

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'video-comments-overlay fixed inset-0 z-50 bg-black bg-opacity-75 flex items-end sm:items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="bg-dark-secondary rounded-t-2xl sm:rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold">Commentaires</h3>
                        <button class="close-comments text-gray-400 hover:text-white">
                            <i data-feather="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="comments-list flex-1 overflow-y-auto p-4 space-y-3 max-h-96">
                        <!-- Comments will be loaded here -->
                        <div class="text-center text-gray-400 py-4">Chargement...</div>
                    </div>
                    <div class="comment-input p-4 border-t border-gray-700">
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                placeholder="Écrire un commentaire..."
                                class="flex-1 bg-dark-primary border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dark-accent text-gray-900 placeholder-gray-500"
                            >
                            <button class="send-comment bg-dark-accent hover:bg-opacity-80 rounded-lg px-4 py-2 text-sm font-medium transition-colors">
                                Envoyer
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Initialize feather icons
            if (window.feather) feather.replace();

            // Load comments
            await loadVideoComments(postId, overlay);

            // Setup event listeners
            setupCommentsOverlayEvents(overlay, postId);
        }

        // Function to load comments for overlay
        async function loadVideoComments(postId, overlay) {
            try {
                const commentsList = overlay.querySelector('.comments-list');
                const comments = await window.echoesInteractions.getComments(postId, 20);

                if (comments.length === 0) {
                    commentsList.innerHTML = '<div class="text-center text-gray-400 py-4">Aucun commentaire pour le moment.</div>';
                    return;
                }

                commentsList.innerHTML = comments.map(comment => `
                    <div class="comment flex space-x-2">
                        <img src="${comment.author?.avatar_url || 'images/default-profil.jpg'}" alt="${comment.author?.username || 'User'}" class="w-8 h-8 rounded-full flex-shrink-0">
                        <div class="flex-1">
                            <div class="bg-dark-primary rounded-lg px-3 py-2">
                                <div class="font-medium text-sm">${escapeHtml(comment.author?.username || comment.author?.full_name || 'Utilisateur')}</div>
                                <p class="text-sm">${escapeHtml(comment.content)}</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(new Date(comment.created_at))}</p>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading comments:', error);
                overlay.querySelector('.comments-list').innerHTML = '<div class="text-center text-red-400 py-4">Erreur lors du chargement des commentaires.</div>';
            }
        }

        // Function to setup overlay events
        function setupCommentsOverlayEvents(overlay, postId) {
            // Close overlay
            overlay.querySelector('.close-comments').addEventListener('click', () => {
                overlay.remove();
            });

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });

            // Send comment
            const sendBtn = overlay.querySelector('.send-comment');
            const input = overlay.querySelector('input');

            const submitComment = async () => {
                const content = input.value.trim();
                if (!content) return;

                try {
                    sendBtn.disabled = true;
                    sendBtn.textContent = 'Envoi...';

                    await window.echoesInteractions.addComment(postId, content);

                    // Reload comments
                    await loadVideoComments(postId, overlay);

                    // Update comment count
                    const commentBtn = document.querySelector(`[data-action="comment"][data-post-id="${postId}"] span`);
                    if (commentBtn) {
                        const count = await window.echoesInteractions.getCommentsCount(postId);
                        commentBtn.textContent = count;
                    }

                    input.value = '';

                } catch (error) {
                    alert('Erreur: ' + (error.message || 'Impossible d\'ajouter le commentaire'));
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Envoyer';
                }
            };

            sendBtn.addEventListener('click', submitComment);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitComment();
                }
            });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initVideosPage();
            initVideoComments();
        });
    </script>
<script src="supabase-config.js"></script>
<script src="supabase-client.js"></script>
<script src="interactions.js"></script>
<script src="badge-injector.js"></script>
<script src="user-badge-display.js"></script>
<script src="dynamic-interactions.js"></script>
<script src="badge-system.js"></script>
<script src="background-init.js"></script>
</body>
</html>
